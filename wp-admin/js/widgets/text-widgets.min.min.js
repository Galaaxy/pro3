wp.textWidgets=(function(t){var p={dismissedPointers:[]};p.TextWidgetControl=Backbone.View.extend({events:{},initialize:function s(b){var a=this;if(!b.el){throw new Error("Missing options.el")}if(!b.syncContainer){throw new Error("Missing options.syncContainer")}Backbone.View.prototype.initialize.call(a,b);a.syncContainer=b.syncContainer;a.$el.addClass("text-widget-fields");a.$el.html(wp.template("widget-text-control-fields"));a.customHtmlWidgetPointer=a.$el.find(".wp-pointer.custom-html-widget-pointer");if(a.customHtmlWidgetPointer.length){a.customHtmlWidgetPointer.find(".close").on("click",function(c){c.preventDefault();a.customHtmlWidgetPointer.hide();t("#"+a.fields.text.attr("id")+"-html").focus();a.dismissPointers(["text_widget_custom_html"])});a.customHtmlWidgetPointer.find(".add-widget").on("click",function(c){c.preventDefault();a.customHtmlWidgetPointer.hide();a.openAvailableWidgetsPanel()})}a.pasteHtmlPointer=a.$el.find(".wp-pointer.paste-html-pointer");if(a.pasteHtmlPointer.length){a.pasteHtmlPointer.find(".close").on("click",function(c){c.preventDefault();a.pasteHtmlPointer.hide();a.editor.focus();a.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])})}a.fields={title:a.$el.find(".title"),text:a.$el.find(".text")};_.each(a.fields,function(e,c){e.on("input change",function d(){var f=a.syncContainer.find(".sync-input."+c);if(f.val()!==e.val()){f.val(e.val());f.trigger("change")}});e.val(a.syncContainer.find(".sync-input."+c).val())})},dismissPointers:function n(a){_.each(a,function(b){wp.ajax.post("dismiss-wp-pointer",{pointer:b});p.dismissedPointers.push(b)})},openAvailableWidgetsPanel:function u(){var a;wp.customize.section.each(function(b){if(b.extended(wp.customize.Widgets.SidebarSection)&&b.expanded()){a=wp.customize.control("sidebars_widgets["+b.params.sidebarId+"]")}});if(!a){return}setTimeout(function(){wp.customize.Widgets.availableWidgetsPanel.open(a);wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")})},updateFields:function l(){var b=this,a;if(!b.fields.title.is(document.activeElement)){a=b.syncContainer.find(".sync-input.title");b.fields.title.val(a.val())}a=b.syncContainer.find(".sync-input.text");if(b.fields.text.is(":visible")){if(!b.fields.text.is(document.activeElement)){b.fields.text.val(a.val())}}else{if(b.editor&&!b.editorFocused&&a.val()!==b.fields.text.val()){b.editor.setContent(wp.editor.autop(a.val()))}}},initializeEditor:function r(){var d=this,b=1000,f,a,c,i=false,h=false;a=d.fields.text;f=a.attr("id");c=function(){var j=300;if(d.editor.isDirty()){if(wp.customize&&wp.customize.state){wp.customize.state("processing").set(wp.customize.state("processing").get()+1);_.delay(function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)},j)}if(!d.editor.isHidden()){d.editor.save()}}if(h){a.trigger("change");h=false}};d.syncContainer.closest(".widget").find("[name=savewidget]:first").on("click",function g(){c()});function e(){var C,k,B;if(!document.getElementById(f)){return}if(typeof window.tinymce==="undefined"){wp.editor.initialize(f,{quicktags:true});return}if(tinymce.get(f)){i=tinymce.get(f).isHidden();wp.editor.remove(f)}wp.editor.initialize(f,{tinymce:{wpautop:true},quicktags:true});B=function(w){w.show();w.find(".close").focus();wp.a11y.speak(w.find("h3, p").map(function(){return t(this).text()}).get().join("\n\n"))};C=window.tinymce.get(f);if(!C){throw new Error("Failed to initialize editor")}k=function(){t(C.getWin()).on("unload",function(){_.defer(e)});if(i){switchEditors.go(f,"html")}t("#"+f+"-html").on("click",function(){d.pasteHtmlPointer.hide();if(-1!==p.dismissedPointers.indexOf("text_widget_custom_html")){return}B(d.customHtmlWidgetPointer)});t("#"+f+"-tmce").on("click",function(){d.customHtmlWidgetPointer.hide()});C.on("pastepreprocess",function(w){var x=w.content;if(-1!==p.dismissedPointers.indexOf("text_widget_paste_html")||!x||!/&lt;\w+.*?&gt;/.test(x)){return}_.delay(function(){B(d.pasteHtmlPointer)},250)})};if(C.initialized){k()}else{C.on("init",k)}d.editorFocused=false;C.on("focus",function E(){d.editorFocused=true});C.on("paste",function D(){C.setDirty(true);c()});C.on("NodeChange",function j(){h=true});C.on("NodeChange",_.debounce(c,b));C.on("blur hide",function F(){d.editorFocused=false;c()});d.editor=C}e()}});p.widgetControls={};p.handleWidgetAdded=function o(g,f){var a,h,k,b,j=50,i,d,c,e;a=f.find("> .widget-inside > .form, > .widget-inside > form");h=a.find("> .id_base").val();if("text"!==h){return}b=a.find(".widget-id").val();if(p.widgetControls[b]){return}if(!a.find(".visual").val()){return}c=t("<div></div>");e=f.find(".widget-content:first");e.before(c);k=new p.TextWidgetControl({el:c,syncContainer:e});p.widgetControls[b]=k;i=f.parent();d=function(){if(i.is(":animated")){setTimeout(d,j)}else{k.initializeEditor()}};d()};p.setupAccessibleMode=function v(){var c,e,b,d,a;c=t(".editwidget > form");if(0===c.length){return}e=c.find("> .widget-control-actions > .id_base").val();if("text"!==e){return}if(!c.find(".visual").val()){return}d=t("<div></div>");a=c.find("> .widget-inside");a.before(d);b=new p.TextWidgetControl({el:d,syncContainer:a});b.initializeEditor()};p.handleWidgetUpdated=function q(d,e){var c,f,b,a;c=e.find("> .widget-inside > .form, > .widget-inside > form");a=c.find("> .id_base").val();if("text"!==a){return}f=c.find("> .widget-id").val();b=p.widgetControls[f];if(!b){return}b.updateFields()};p.init=function m(){var a=t(document);a.on("widget-added",p.handleWidgetAdded);a.on("widget-synced widget-updated",p.handleWidgetUpdated);t(function b(){var d;if("widgets"!==window.pagenow){return}d=t(".widgets-holder-wrap:not(#available-widgets)").find("div.widget");d.one("click.toggle-widget-expanded",function c(){var e=t(this);p.handleWidgetAdded(new jQuery.Event("widget-added"),e)});t(window).on("load",function(){p.setupAccessibleMode()})})};return p})(jQuery);