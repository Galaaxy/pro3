wp.textWidgets=(function(c){var g={dismissedPointers:[]};g.TextWidgetControl=Backbone.View.extend({events:{},initialize:function d(l){var m=this;if(!l.el){throw new Error("Missing options.el")}if(!l.syncContainer){throw new Error("Missing options.syncContainer")}Backbone.View.prototype.initialize.call(m,l);m.syncContainer=l.syncContainer;m.$el.addClass("text-widget-fields");m.$el.html(wp.template("widget-text-control-fields"));m.customHtmlWidgetPointer=m.$el.find(".wp-pointer.custom-html-widget-pointer");if(m.customHtmlWidgetPointer.length){m.customHtmlWidgetPointer.find(".close").on("click",function(n){n.preventDefault();m.customHtmlWidgetPointer.hide();c("#"+m.fields.text.attr("id")+"-html").focus();m.dismissPointers(["text_widget_custom_html"])});m.customHtmlWidgetPointer.find(".add-widget").on("click",function(n){n.preventDefault();m.customHtmlWidgetPointer.hide();m.openAvailableWidgetsPanel()})}m.pasteHtmlPointer=m.$el.find(".wp-pointer.paste-html-pointer");if(m.pasteHtmlPointer.length){m.pasteHtmlPointer.find(".close").on("click",function(n){n.preventDefault();m.pasteHtmlPointer.hide();m.editor.focus();m.dismissPointers(["text_widget_custom_html","text_widget_paste_html"])})}m.fields={title:m.$el.find(".title"),text:m.$el.find(".text")};_.each(m.fields,function(n,p){n.on("input change",function o(){var q=m.syncContainer.find(".sync-input."+p);if(q.val()!==n.val()){q.val(n.val());q.trigger("change")}});n.val(m.syncContainer.find(".sync-input."+p).val())})},dismissPointers:function i(l){_.each(l,function(m){wp.ajax.post("dismiss-wp-pointer",{pointer:m});g.dismissedPointers.push(m)})},openAvailableWidgetsPanel:function b(){var l;wp.customize.section.each(function(m){if(m.extended(wp.customize.Widgets.SidebarSection)&&m.expanded()){l=wp.customize.control("sidebars_widgets["+m.params.sidebarId+"]")}});if(!l){return}setTimeout(function(){wp.customize.Widgets.availableWidgetsPanel.open(l);wp.customize.Widgets.availableWidgetsPanel.$search.val("HTML").trigger("keyup")})},updateFields:function k(){var l=this,m;if(!l.fields.title.is(document.activeElement)){m=l.syncContainer.find(".sync-input.title");l.fields.title.val(m.val())}m=l.syncContainer.find(".sync-input.text");if(l.fields.text.is(":visible")){if(!l.fields.text.is(document.activeElement)){l.fields.text.val(m.val())}}else{if(l.editor&&!l.editorFocused&&m.val()!==l.fields.text.val()){l.editor.setContent(wp.editor.autop(m.val()))}}},initializeEditor:function e(){var o=this,q=1000,m,r,p,s=false,t=false;r=o.fields.text;m=r.attr("id");p=function(){var u=300;if(o.editor.isDirty()){if(wp.customize&&wp.customize.state){wp.customize.state("processing").set(wp.customize.state("processing").get()+1);_.delay(function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)},u)}if(!o.editor.isHidden()){o.editor.save()}}if(t){r.trigger("change");t=false}};o.syncContainer.closest(".widget").find("[name=savewidget]:first").on("click",function l(){p()});function n(){var v,x,w;if(!document.getElementById(m)){return}if(typeof window.tinymce==="undefined"){wp.editor.initialize(m,{quicktags:true});return}if(tinymce.get(m)){s=tinymce.get(m).isHidden();wp.editor.remove(m)}wp.editor.initialize(m,{tinymce:{wpautop:true},quicktags:true});w=function(B){B.show();B.find(".close").focus();wp.a11y.speak(B.find("h3, p").map(function(){return c(this).text()}).get().join("\n\n"))};v=window.tinymce.get(m);if(!v){throw new Error("Failed to initialize editor")}x=function(){c(v.getWin()).on("unload",function(){_.defer(n)});if(s){switchEditors.go(m,"html")}c("#"+m+"-html").on("click",function(){o.pasteHtmlPointer.hide();if(-1!==g.dismissedPointers.indexOf("text_widget_custom_html")){return}w(o.customHtmlWidgetPointer)});c("#"+m+"-tmce").on("click",function(){o.customHtmlWidgetPointer.hide()});v.on("pastepreprocess",function(C){var B=C.content;if(-1!==g.dismissedPointers.indexOf("text_widget_paste_html")||!B||!/&lt;\w+.*?&gt;/.test(B)){return}_.delay(function(){w(o.pasteHtmlPointer)},250)})};if(v.initialized){x()}else{v.on("init",x)}o.editorFocused=false;v.on("focus",function z(){o.editorFocused=true});v.on("paste",function u(){v.setDirty(true);p()});v.on("NodeChange",function A(){t=true});v.on("NodeChange",_.debounce(p,q));v.on("blur hide",function y(){o.editorFocused=false;p()});o.editor=v}n()}});g.widgetControls={};g.handleWidgetAdded=function h(l,m){var r,v,s,q,t=50,u,o,p,n;r=m.find("> .widget-inside > .form, > .widget-inside > form");v=r.find("> .id_base").val();if("text"!==v){return}q=r.find(".widget-id").val();if(g.widgetControls[q]){return}if(!r.find(".visual").val()){return}p=c("<div></div>");n=m.find(".widget-content:first");n.before(p);s=new g.TextWidgetControl({el:p,syncContainer:n});g.widgetControls[q]=s;u=m.parent();o=function(){if(u.is(":animated")){setTimeout(o,t)}else{s.initializeEditor()}};o()};g.setupAccessibleMode=function a(){var p,n,l,o,m;p=c(".editwidget > form");if(0===p.length){return}n=p.find("> .widget-control-actions > .id_base").val();if("text"!==n){return}if(!p.find(".visual").val()){return}o=c("<div></div>");m=p.find("> .widget-inside");m.before(o);l=new g.TextWidgetControl({el:o,syncContainer:m});l.initializeEditor()};g.handleWidgetUpdated=function f(p,o){var q,n,l,m;q=o.find("> .widget-inside > .form, > .widget-inside > form");m=q.find("> .id_base").val();if("text"!==m){return}n=q.find("> .widget-id").val();l=g.widgetControls[n];if(!l){return}l.updateFields()};g.init=function j(){var m=c(document);m.on("widget-added",g.handleWidgetAdded);m.on("widget-synced widget-updated",g.handleWidgetUpdated);c(function l(){var n;if("widgets"!==window.pagenow){return}n=c(".widgets-holder-wrap:not(#available-widgets)").find("div.widget");n.one("click.toggle-widget-expanded",function o(){var p=c(this);g.handleWidgetAdded(new jQuery.Event("widget-added"),p)});c(window).on("load",function(){g.setupAccessibleMode()})})};return g})(jQuery);