var wpLink;(function(e,g,m){var j,d,a,h,o,k,n=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,63}$/i,f=/^(https?|ftp):\/\/[A-Z0-9.-]+\.[A-Z]{2,63}[^ "]*$/i,i={},c={},b=("ontouchend" in document);function l(){return k||j.dom.getParent(j.selection.getNode(),"a[href]")}wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",modalOpen:false,init:function(){i.wrap=e("#wp-link-wrap");i.dialog=e("#wp-link");i.backdrop=e("#wp-link-backdrop");i.submit=e("#wp-link-submit");i.close=e("#wp-link-close");i.text=e("#wp-link-text");i.url=e("#wp-link-url");i.nonce=e("#_ajax_linking_nonce");i.openInNewTab=e("#wp-link-target");i.search=e("#wp-link-search");c.search=new a(e("#search-results"));c.recent=new a(e("#most-recent-results"));c.elements=i.dialog.find(".query-results");i.queryNotice=e("#query-notice-message");i.queryNoticeTextDefault=i.queryNotice.find(".query-notice-default");i.queryNoticeTextHint=i.queryNotice.find(".query-notice-hint");i.dialog.keydown(wpLink.keydown);i.dialog.keyup(wpLink.keyup);i.submit.click(function(p){p.preventDefault();wpLink.update()});i.close.add(i.backdrop).add("#wp-link-cancel button").click(function(p){p.preventDefault();wpLink.close()});c.elements.on("river-select",wpLink.updateFields);i.search.on("focus.wplink",function(){i.queryNoticeTextDefault.hide();i.queryNoticeTextHint.removeClass("screen-reader-text").show()}).on("blur.wplink",function(){i.queryNoticeTextDefault.show();i.queryNoticeTextHint.addClass("screen-reader-text").hide()});i.search.on("keyup input",function(){window.clearTimeout(d);d=window.setTimeout(function(){wpLink.searchInternalLinks()},500)});i.url.on("paste",function(){setTimeout(wpLink.correctURL,0)});i.url.on("blur",wpLink.correctURL)},correctURL:function(){var p=e.trim(i.url.val());if(p&&o!==p&&!/^(?:[a-z]+:|#|\?|\.|\/)/.test(p)){i.url.val("http://"+p);o=p}},open:function(r,q,u,s){var p,t=e(document.body);t.addClass("modal-open");wpLink.modalOpen=true;k=s;wpLink.range=null;if(r){window.wpActiveEditor=r}if(!window.wpActiveEditor){return}this.textarea=e("#"+window.wpActiveEditor).get(0);if(typeof window.tinymce!=="undefined"){t.append(i.backdrop,i.wrap);p=window.tinymce.get(window.wpActiveEditor);if(p&&!p.isHidden()){j=p}else{j=null}}if(!wpLink.isMCE()&&document.selection){this.textarea.focus();this.range=document.selection.createRange()}i.wrap.show();i.backdrop.show();wpLink.refresh(q,u);e(document).trigger("wplink-open",i.wrap)},isMCE:function(){return j&&!j.isHidden()},refresh:function(p,r){var q="";c.search.refresh();c.recent.refresh();if(wpLink.isMCE()){wpLink.mceRefresh(p,r)}else{if(!i.wrap.hasClass("has-text-field")){i.wrap.addClass("has-text-field")}if(document.selection){q=document.selection.createRange().text||r||""}else{if(typeof this.textarea.selectionStart!=="undefined"&&(this.textarea.selectionStart!==this.textarea.selectionEnd)){r=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)||r||""}}i.text.val(r);wpLink.setDefaultValues()}if(b){i.url.focus().blur()}else{window.setTimeout(function(){i.url[0].select();i.url.focus()})}if(!c.recent.ul.children().length){c.recent.ajax()}o=i.url.val().replace(/^http:\/\//,"")},hasSelectedText:function(p){var t,q,s,r=j.selection.getContent();if(/</.test(r)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(r)||r.indexOf("href=")===-1)){return false}if(p){q=p.childNodes;if(q.length===0){return false}for(s=q.length-1;s>=0;s--){t=q[s];if(t.nodeType!=3&&!window.tinymce.dom.BookmarkManager.isBookmarkNode(t)){return false}}}return true},mceRefresh:function(r,u){var s,q,p=l(),t=this.hasSelectedText(p);if(p){s=p.textContent||p.innerText;q=j.dom.getAttrib(p,"href");if(!e.trim(s)){s=u||""}if(r&&(f.test(r)||n.test(r))){q=r}if(q!=="_wp_link_placeholder"){i.url.val(q);i.openInNewTab.prop("checked","_blank"===j.dom.getAttrib(p,"target"));i.submit.val(g.update)}else{this.setDefaultValues(s)}if(r&&r!==q){i.search.val(r)}else{i.search.val("")}window.setTimeout(function(){wpLink.searchInternalLinks()})}else{s=j.selection.getContent({format:"text"})||u||"";this.setDefaultValues(s)}if(t){i.text.val(s);i.wrap.addClass("has-text-field")}else{i.text.val("");i.wrap.removeClass("has-text-field")}},close:function(p){e(document.body).removeClass("modal-open");wpLink.modalOpen=false;if(p!=="noReset"){if(!wpLink.isMCE()){wpLink.textarea.focus();if(wpLink.range){wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select()}}else{if(j.plugins.wplink){j.plugins.wplink.close()}j.focus()}}i.backdrop.hide();i.wrap.hide();o=false;e(document).trigger("wplink-close",i.wrap)},getAttrs:function(){wpLink.correctURL();return{href:e.trim(i.url.val()),target:i.openInNewTab.prop("checked")?"_blank":null}},buildHtml:function(p){var q='<a href="'+p.href+'"';if(p.target){q+=' rel="noopener" target="'+p.target+'"'}return q+">"},update:function(){if(wpLink.isMCE()){wpLink.mceUpdate()}else{wpLink.htmlUpdate()}},htmlUpdate:function(){var v,w,s,q,r,x,t,u=wpLink.textarea;if(!u){return}v=wpLink.getAttrs();w=i.text.val();var p=document.createElement("a");p.href=v.href;if("javascript:"===p.protocol||"data:"===p.protocol){v.href=""}if(!v.href){return}s=wpLink.buildHtml(v);if(document.selection&&wpLink.range){u.focus();wpLink.range.text=s+(w||wpLink.range.text)+"</a>";wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select();wpLink.range=null}else{if(typeof u.selectionStart!=="undefined"){q=u.selectionStart;r=u.selectionEnd;t=w||u.value.substring(q,r);s=s+t+"</a>";x=q+s.length;if(q===r&&!t){x-=4}u.value=(u.value.substring(0,q)+s+u.value.substring(r,u.value.length));u.selectionStart=u.selectionEnd=x}}wpLink.close();u.focus();e(u).trigger("change");m.a11y.speak(g.linkInserted)},mceUpdate:function(){var q=wpLink.getAttrs(),p,t,r,s;var u=document.createElement("a");u.href=q.href;if("javascript:"===u.protocol||"data:"===u.protocol){q.href=""}if(!q.href){j.execCommand("unlink");wpLink.close();return}p=j.$(l());j.undoManager.transact(function(){if(!p.length){j.execCommand("mceInsertLink",false,{href:"_wp_link_placeholder","data-wp-temp-link":1});p=j.$('a[data-wp-temp-link="1"]').removeAttr("data-wp-temp-link");r=e.trim(p.text())}if(!p.length){j.execCommand("unlink")}else{if(i.wrap.hasClass("has-text-field")){t=i.text.val();if(t){p.text(t)}else{if(!r){p.text(q.href)}}}q["data-wplink-edit"]=null;q["data-mce-href"]=null;p.attr(q)}});wpLink.close("noReset");j.focus();if(p.length){s=p.parent("#_mce_caret");if(s.length){s.before(p.removeAttr("data-mce-bogus"))}j.selection.select(p[0]);j.selection.collapse();if(j.plugins.wplink){j.plugins.wplink.checkLink(p[0])}}j.nodeChanged();m.a11y.speak(g.linkInserted)},updateFields:function(q,p){i.url.val(p.children(".item-permalink").val())},getUrlFromSelection:function(p){if(!p){if(this.isMCE()){p=j.selection.getContent({format:"text"})}else{if(document.selection&&wpLink.range){p=wpLink.range.text}else{if(typeof this.textarea.selectionStart!=="undefined"){p=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)}}}}p=e.trim(p);if(p&&n.test(p)){return"mailto:"+p}else{if(p&&f.test(p)){return p.replace(/&amp;|&#0?38;/gi,"&")}}return""},setDefaultValues:function(p){i.url.val(this.getUrlFromSelection(p));i.search.val("");wpLink.searchInternalLinks();i.submit.val(g.save)},searchInternalLinks:function(){var q,p=i.search.val()||"";if(p.length>2){c.recent.hide();c.search.show();if(wpLink.lastSearch==p){return}wpLink.lastSearch=p;q=i.search.parent().find(".spinner").addClass("is-active");c.search.change(p);c.search.ajax(function(){q.removeClass("is-active")})}else{c.search.hide();c.recent.show()}},next:function(){c.search.next();c.recent.next()},prev:function(){c.search.prev();c.recent.prev()},keydown:function(q){var p,r;if(27===q.keyCode){wpLink.close();q.stopImmediatePropagation()}else{if(9===q.keyCode){r=q.target.id;if(r==="wp-link-submit"&&!q.shiftKey){i.close.focus();q.preventDefault()}else{if(r==="wp-link-close"&&q.shiftKey){i.submit.focus();q.preventDefault()}}}}if(38!==q.keyCode&&40!==q.keyCode){return}if(document.activeElement&&(document.activeElement.id==="link-title-field"||document.activeElement.id==="url-field")){return}p=38===q.keyCode?"prev":"next";clearInterval(wpLink.keyInterval);wpLink[p]();wpLink.keyInterval=setInterval(wpLink[p],wpLink.keySensitivity);q.preventDefault()},keyup:function(p){if(38===p.keyCode||40===p.keyCode){clearInterval(wpLink.keyInterval);p.preventDefault()}},delayedCallback:function(r,p){var u,t,s,q;if(!p){return r}setTimeout(function(){if(t){return r.apply(q,s)}u=true},p);return function(){if(u){return r.apply(this,arguments)}s=arguments;q=this;t=true}}};a=function(r,q){var p=this;this.element=r;this.ul=r.children("ul");this.contentHeight=r.children("#link-selector-height");this.waiting=r.find(".river-waiting");this.change(q);this.refresh();e("#wp-link .query-results, #wp-link #link-selector").scroll(function(){p.maybeLoad()});r.on("click","li",function(s){p.select(e(this),s)})};e.extend(a.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},show:function(){if(!this.visible){this.deselect();this.element.show();this.visible=true}},hide:function(){this.element.hide();this.visible=false},select:function(q,t){var s,r,u,p;if(q.hasClass("unselectable")||q==this.selected){return}this.deselect();this.selected=q.addClass("selected");s=q.outerHeight();r=this.element.height();u=q.position().top;p=this.element.scrollTop();if(u<0){this.element.scrollTop(p+u)}else{if(u+s>r){this.element.scrollTop(p+u-r+s)}}this.element.trigger("river-select",[q,t,this])},deselect:function(){if(this.selected){this.selected.removeClass("selected")}this.selected=false},prev:function(){if(!this.visible){return}var p;if(this.selected){p=this.selected.prev("li");if(p.length){this.select(p)}}},next:function(){if(!this.visible){return}var p=this.selected?this.selected.next("li"):e("li:not(.unselectable):first",this.element);if(p.length){this.select(p)}},ajax:function(s){var q=this,r=this.query.page==1?0:wpLink.minRiverAJAXDuration,p=wpLink.delayedCallback(function(t,u){q.process(t,u);if(s){s(t,u)}},r);this.query.ajax(p)},change:function(p){if(this.query&&this._search==p){return}this._search=p;this.query=new h(p);this.element.scrollTop(0)},process:function(q,u){var r="",s=true,p="",t=u.page==1;if(!q){if(t){r+='<li class="unselectable no-matches-found"><span class="item-title"><em>'+g.noMatchesFound+"</em></span></li>"}}else{e.each(q,function(){p=s?"alternate":"";p+=this.title?"":" no-title";r+=p?'<li class="'+p+'">':"<li>";r+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />';r+='<span class="item-title">';r+=this.title?this.title:g.noTitle;r+='</span><span class="item-info">'+this.info+"</span></li>";s=!s})}this.ul[t?"html":"append"](r)},maybeLoad:function(){var q=this,r=this.element,p=r.scrollTop()+r.height();if(!this.query.ready()||p<this.contentHeight.height()-wpLink.riverBottomThreshold){return}setTimeout(function(){var s=r.scrollTop(),t=s+r.height();if(!q.query.ready()||t<q.contentHeight.height()-wpLink.riverBottomThreshold){return}q.waiting.addClass("is-active");r.scrollTop(s+q.waiting.outerHeight());q.ajax(function(){q.waiting.removeClass("is-active")})},wpLink.timeToTriggerRiver)}});h=function(p){this.page=1;this.allLoaded=false;this.querying=false;this.search=p};e.extend(h.prototype,{ready:function(){return !(this.querying||this.allLoaded)},ajax:function(r){var p=this,q={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:i.nonce.val()};if(this.search){q.search=this.search}this.querying=true;e.post(window.ajaxurl,q,function(s){p.page++;p.querying=false;p.allLoaded=!s;r(s,q)},"json")}});e(document).ready(wpLink.init)})(jQuery,window.wpLinkL10n,window.wp);