!function(h,g,l,k){var j={},i={};g.mce=g.mce||{},g.mce.views={register:function(b,d){j[b]=g.mce.View.extend(_.extend(d,{type:b}))},unregister:function(b){delete j[b]},get:function(b){return j[b]},unbind:function(){_.each(i,function(b){b.unbind()})},setMarkers:function(m){var e,p,o=[{content:m}],n=this;return _.each(j,function(b,c){p=o.slice(),o=[],_.each(p,function(q){var f,d,a=q.content;if(q.processed){return void o.push(q)}for(;a&&(f=b.prototype.match(a));){f.index&&o.push({content:a.substring(0,f.index)}),e=n.createInstance(c,f.content,f.options),d=e.loader?".":e.text,o.push({content:e.ignore?d:'<p data-wpview-marker="'+e.encodedText+'">'+d+"</p>",processed:!0}),a=a.slice(f.index+f.content.length)}a&&o.push({content:a})})}),m=_.pluck(o,"content").join(""),m.replace(/<p>\s*<p data-wpview-marker=/g,"<p data-wpview-marker=").replace(/<\/p>\s*<\/p>/g,"</p>")},createInstance:function(m,f,r,q){var p,o,n=this.get(m);return f.indexOf("[")!==-1&&f.indexOf("]")!==-1&&(f=f.replace(/\[[^\]]+\]/g,function(b){return b.replace(/[\r\n]/g,"")})),!q&&(o=this.getInstance(f))?o:(p=encodeURIComponent(f),r=_.extend(r||{},{text:f,encodedText:p}),i[p]=new n(r))},getInstance:function(b){return"string"==typeof b?i[encodeURIComponent(b)]:i[k(b).attr("data-wpview-text")]},getText:function(b){return decodeURIComponent(k(b).attr("data-wpview-text")||"")},render:function(b){_.each(i,function(a){a.render(null,b)})},update:function(m,f,p,o){var n=this.getInstance(p);n&&n.update(m,f,p,o)},edit:function(e,d){var f=this.getInstance(d);f&&f.edit&&f.edit(f.text,function(b,a){f.update(b,e,d,a)})},remove:function(e,d){var f=this.getInstance(d);f&&f.remove(e,d)}},g.mce.View=function(b){_.extend(this,b),this.initialize()},g.mce.View.extend=Backbone.View.extend,_.extend(g.mce.View.prototype,{content:null,loader:!0,initialize:function(){},getContent:function(){return this.content},render:function(d,c){null!=d&&(this.content=d),d=this.getContent(),(this.loader||d)&&(c&&this.unbind(),this.replaceMarkers(),d?this.setContent(d,function(f,e){k(e).data("rendered",!0),this.bindNode.call(this,f,e)},!!c&&null):this.setLoader())},bindNode:function(){},unbindNode:function(){},unbind:function(){this.getNodes(function(d,c){this.unbindNode.call(this,d,c)},!0)},getEditors:function(b){_.each(tinymce.editors,function(a){a.plugins.wpview&&b.call(this,a)},this)},getNodes:function(d,c){this.getEditors(function(b){var a=this;k(b.getBody()).find('[data-wpview-text="'+a.encodedText+'"]').filter(function(){var e;return null==c||(e=k(this).data("rendered")===!0,c?e:!e)}).each(function(){d.call(a,b,this,this)})})},getMarkers:function(b){this.getEditors(function(a){var d=this;k(a.getBody()).find('[data-wpview-marker="'+this.encodedText+'"]').each(function(){b.call(d,a,this)})})},replaceMarkers:function(){this.getMarkers(function(f,d){var n,m=d===f.selection.getNode();return this.loader||k(d).text()===tinymce.DOM.decode(this.text)?(n=f.$('<div class="wpview wpview-wrap" data-wpview-text="'+this.encodedText+'" data-wpview-type="'+this.type+'" contenteditable="false"></div>'),f.$(d).replaceWith(n),void (m&&setTimeout(function(){f.selection.select(n[0]),f.selection.collapse()}))):void f.dom.setAttrib(d,"data-wpview-marker",null)})},removeMarkers:function(){this.getMarkers(function(d,c){d.dom.setAttrib(c,"data-wpview-marker",null)})},setContent:function(e,d,f){_.isObject(e)&&(e.sandbox||e.head||e.body.indexOf("<script")!==-1)?this.setIframes(e.head||"",e.body,d,f):_.isString(e)&&e.indexOf("<script")!==-1?this.setIframes("",e,d,f):this.getNodes(function(b,a){e=e.body||e,e.indexOf("<iframe")!==-1&&(e+='<span class="mce-shim"></span>'),b.undoManager.transact(function(){a.innerHTML="",a.appendChild(_.isString(e)?b.dom.createFragment(e):e),b.dom.add(a,"span",{"class":"wpview-end"})}),d&&d.call(this,b,a)},f)},setIframes:function(o,n,m,d){var b=this;if(n.indexOf("[")!==-1&&n.indexOf("]")!==-1){var a=new RegExp("\\[\\/?(?:"+h.mceViewL10n.shortcodes.join("|")+")[^\\]]*?\\]","g");n=n.replace(a,function(c){return c.replace(/</g,"&lt;").replace(/>/g,"&gt;")})}this.getNodes(function(E,D){function C(){var p;c||z.contentWindow&&(p=k(z),b.iframeHeight=k(x.body).height(),p.height()!==b.iframeHeight&&(p.height(b.iframeHeight),E.nodeChanged()))}function B(){E.isHidden()||(k(D).data("rendered",null),setTimeout(function(){g.mce.views.render()}))}function A(){f=new w(_.debounce(C,100)),f.observe(x.body,{attributes:!0,childList:!0,subtree:!0})}var z,y,x,w,f,e,c,I=E.dom,H="",G=E.getBody().className||"",F=E.getDoc().getElementsByTagName("head")[0];if(tinymce.each(I.$('link[rel="stylesheet"]',F),function(p){p.href&&p.href.indexOf("skins/lightgray/content.min.css")===-1&&p.href.indexOf("skins/wordpress/wp-content.css")===-1&&(H+=I.getOuterHTML(p))}),b.iframeHeight&&I.add(D,"span",{"data-mce-bogus":1,style:{display:"block",width:"100%",height:b.iframeHeight}},"\u200b"),E.undoManager.transact(function(){D.innerHTML="",z=I.add(D,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"},height:b.iframeHeight}),I.add(D,"span",{"class":"mce-shim"}),I.add(D,"span",{"class":"wpview-end"})}),z.contentWindow){if(y=z.contentWindow,x=y.document,x.open(),x.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+o+H+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}iframe {max-width: 100%;}</style></head><body id="wpview-iframe-sandbox" class="'+G+'">'+n+"</body></html>"),x.close(),b.iframeHeight&&(c=!0,setTimeout(function(){c=!1,C()},3000)),k(y).on("load",C).on("unload",B),w=y.MutationObserver||y.WebKitMutationObserver||y.MozMutationObserver){x.body?A():x.addEventListener("DOMContentLoaded",A,!1)}else{for(e=1;e<6;e++){setTimeout(C,700*e)}}m&&m.call(b,E,D)}},d)},setLoader:function(b){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-'+(b||"admin-media")+'"></div><div class="wpview-loading"><ins></ins></div></div>')},setError:function(d,c){this.setContent('<div class="wpview-error"><div class="dashicons dashicons-'+(c||"no")+'"></div><p>'+d+"</p></div>")},match:function(d){var c=l.next(this.type,d);if(c){return{index:c.index,content:c.content,options:{shortcode:c.shortcode}}}},update:function(b,m,e,d){_.find(j,function(f,c){var a=f.prototype.match(b);if(a){return k(e).data("rendered",!1),m.dom.setAttrib(e,"data-wpview-text",encodeURIComponent(b)),g.mce.views.createInstance(c,b,a.options,d).render(),m.selection.select(e),m.nodeChanged(),m.focus(),!0}})},remove:function(d,c){this.unbindNode.call(this,d,c),d.dom.remove(c),d.focus()}})}(window,window.wp,window.wp.shortcode,window.jQuery),function(x,w,v,u){function t(a){var d={};return x.tinymce?!a||a.indexOf("<")===-1&&a.indexOf(">")===-1?a:(o=o||new x.tinymce.html.Schema(d),n=n||new x.tinymce.html.DomParser(d,o),m=m||new x.tinymce.html.Serializer(d,o),m.serialize(n.parse(a,{forced_root_block:!1}))):a.replace(/<[^>]+>/g,"")}var s,r,q,p,o,n,m;s={state:[],edit:function(f,c){var h=this.type,g=v[h].edit(f);this.pausePlayers&&this.pausePlayers(),_.each(this.state,function(b){g.state(b).on("update",function(d){c(v[h].shortcode(d).string(),"gallery"===h)})}),g.on("close",function(){g.detach()}),g.open()}},r=_.extend({},s,{state:["gallery-edit"],template:v.template("editor-gallery"),initialize:function(){var e=v.gallery.attachments(this.shortcode,v.view.settings.post.id),c=this.shortcode.attrs.named,f=this;e.more().done(function(){e=e.toJSON(),_.each(e,function(b){b.sizes&&(c.size&&b.sizes[c.size]?b.thumbnail=b.sizes[c.size]:b.sizes.thumbnail?b.thumbnail=b.sizes.thumbnail:b.sizes.full&&(b.thumbnail=b.sizes.full))}),f.render(f.template({verifyHTML:t,attachments:e,columns:c.columns?parseInt(c.columns,10):v.galleryDefaults.columns}))}).fail(function(g,d){f.setError(d)})}}),q=_.extend({},s,{action:"parse-media-shortcode",initialize:function(){var b=this;this.url&&(this.loader=!1,this.shortcode=v.embed.shortcode({url:this.text})),wp.ajax.post(this.action,{post_ID:v.view.settings.post.id,type:this.shortcode.tag,shortcode:this.shortcode.string()}).done(function(a){b.render(a)}).fail(function(a){b.url?(b.ignore=!0,b.removeMarkers()):b.setError(a.message||a.statusText,"admin-media")}),this.getEditors(function(a){a.on("wpview-selected",function(){b.pausePlayers()})})},pausePlayers:function(){this.getNodes(function(f,d,h){var g=u("iframe.wpview-sandbox",h).get(0);g&&(g=g.contentWindow)&&g.mejs&&_.each(g.mejs.players,function(e){try{e.pause()}catch(c){}})})}}),p=_.extend({},q,{action:"parse-embed",edit:function(f,c){var h=v.embed.edit(f,this.url),g=this;this.pausePlayers(),h.state("embed").props.on("change:url",function(e,d){d&&e.get("url")&&(h.state("embed").metadata=e.toJSON())}),h.state("embed").on("select",function(){var b=h.state("embed").metadata;c(g.url?b.url:v.embed.shortcode(b).string())}),h.on("close",function(){h.detach()}),h.open()}}),w.register("gallery",_.extend({},r)),w.register("audio",_.extend({},q,{state:["audio-details"]})),w.register("video",_.extend({},q,{state:["video-details"]})),w.register("playlist",_.extend({},q,{state:["playlist-edit","video-playlist-edit"]})),w.register("embed",_.extend({},p)),w.register("embedURL",_.extend({},p,{match:function(e){var d=/(^|<p>)(https?:\/\/[^\s"]+?)(<\/p>\s*|$)/gi,f=d.exec(e);if(f){return{index:f.index+f[1].length,content:f[2],options:{url:!0}}}}}))}(window,window.wp.mce.views,window.wp.media,window.jQuery);