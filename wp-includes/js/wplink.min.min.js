var wpLink;(function(z,x,r){var u,A,D,w,p,t,q=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,63}$/i,y=/^(https?|ftp):\/\/[A-Z0-9.-]+\.[A-Z]{2,63}[^ "]*$/i,v={},B={},C=("ontouchend" in document);function s(){return t||u.dom.getParent(u.selection.getNode(),"a[href]")}wpLink={timeToTriggerRiver:150,minRiverAJAXDuration:200,riverBottomThreshold:5,keySensitivity:100,lastSearch:"",textarea:"",modalOpen:false,init:function(){v.wrap=z("#wp-link-wrap");v.dialog=z("#wp-link");v.backdrop=z("#wp-link-backdrop");v.submit=z("#wp-link-submit");v.close=z("#wp-link-close");v.text=z("#wp-link-text");v.url=z("#wp-link-url");v.nonce=z("#_ajax_linking_nonce");v.openInNewTab=z("#wp-link-target");v.search=z("#wp-link-search");B.search=new D(z("#search-results"));B.recent=new D(z("#most-recent-results"));B.elements=v.dialog.find(".query-results");v.queryNotice=z("#query-notice-message");v.queryNoticeTextDefault=v.queryNotice.find(".query-notice-default");v.queryNoticeTextHint=v.queryNotice.find(".query-notice-hint");v.dialog.keydown(wpLink.keydown);v.dialog.keyup(wpLink.keyup);v.submit.click(function(a){a.preventDefault();wpLink.update()});v.close.add(v.backdrop).add("#wp-link-cancel button").click(function(a){a.preventDefault();wpLink.close()});B.elements.on("river-select",wpLink.updateFields);v.search.on("focus.wplink",function(){v.queryNoticeTextDefault.hide();v.queryNoticeTextHint.removeClass("screen-reader-text").show()}).on("blur.wplink",function(){v.queryNoticeTextDefault.show();v.queryNoticeTextHint.addClass("screen-reader-text").hide()});v.search.on("keyup input",function(){window.clearTimeout(A);A=window.setTimeout(function(){wpLink.searchInternalLinks()},500)});v.url.on("paste",function(){setTimeout(wpLink.correctURL,0)});v.url.on("blur",wpLink.correctURL)},correctURL:function(){var a=z.trim(v.url.val());if(a&&p!==a&&!/^(?:[a-z]+:|#|\?|\.|\/)/.test(a)){v.url.val("http://"+a);p=a}},open:function(d,e,a,c){var f,b=z(document.body);b.addClass("modal-open");wpLink.modalOpen=true;t=c;wpLink.range=null;if(d){window.wpActiveEditor=d}if(!window.wpActiveEditor){return}this.textarea=z("#"+window.wpActiveEditor).get(0);if(typeof window.tinymce!=="undefined"){b.append(v.backdrop,v.wrap);f=window.tinymce.get(window.wpActiveEditor);if(f&&!f.isHidden()){u=f}else{u=null}}if(!wpLink.isMCE()&&document.selection){this.textarea.focus();this.range=document.selection.createRange()}v.wrap.show();v.backdrop.show();wpLink.refresh(e,a);z(document).trigger("wplink-open",v.wrap)},isMCE:function(){return u&&!u.isHidden()},refresh:function(c,a){var b="";B.search.refresh();B.recent.refresh();if(wpLink.isMCE()){wpLink.mceRefresh(c,a)}else{if(!v.wrap.hasClass("has-text-field")){v.wrap.addClass("has-text-field")}if(document.selection){b=document.selection.createRange().text||a||""}else{if(typeof this.textarea.selectionStart!=="undefined"&&(this.textarea.selectionStart!==this.textarea.selectionEnd)){a=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)||a||""}}v.text.val(a);wpLink.setDefaultValues()}if(C){v.url.focus().blur()}else{window.setTimeout(function(){v.url[0].select();v.url.focus()})}if(!B.recent.ul.children().length){B.recent.ajax()}p=v.url.val().replace(/^http:\/\//,"")},hasSelectedText:function(e){var a,d,b,c=u.selection.getContent();if(/</.test(c)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(c)||c.indexOf("href=")===-1)){return false}if(e){d=e.childNodes;if(d.length===0){return false}for(b=d.length-1;b>=0;b--){a=d[b];if(a.nodeType!=3&&!window.tinymce.dom.BookmarkManager.isBookmarkNode(a)){return false}}}return true},mceRefresh:function(d,a){var c,e,f=s(),b=this.hasSelectedText(f);if(f){c=f.textContent||f.innerText;e=u.dom.getAttrib(f,"href");if(!z.trim(c)){c=a||""}if(d&&(y.test(d)||q.test(d))){e=d}if(e!=="_wp_link_placeholder"){v.url.val(e);v.openInNewTab.prop("checked","_blank"===u.dom.getAttrib(f,"target"));v.submit.val(x.update)}else{this.setDefaultValues(c)}if(d&&d!==e){v.search.val(d)}else{v.search.val("")}window.setTimeout(function(){wpLink.searchInternalLinks()})}else{c=u.selection.getContent({format:"text"})||a||"";this.setDefaultValues(c)}if(b){v.text.val(c);v.wrap.addClass("has-text-field")}else{v.text.val("");v.wrap.removeClass("has-text-field")}},close:function(a){z(document.body).removeClass("modal-open");wpLink.modalOpen=false;if(a!=="noReset"){if(!wpLink.isMCE()){wpLink.textarea.focus();if(wpLink.range){wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select()}}else{if(u.plugins.wplink){u.plugins.wplink.close()}u.focus()}}v.backdrop.hide();v.wrap.hide();p=false;z(document).trigger("wplink-close",v.wrap)},getAttrs:function(){wpLink.correctURL();return{href:z.trim(v.url.val()),target:v.openInNewTab.prop("checked")?"_blank":null}},buildHtml:function(b){var a='<a href="'+b.href+'"';if(b.target){a+=' rel="noopener" target="'+b.target+'"'}return a+">"},update:function(){if(wpLink.isMCE()){wpLink.mceUpdate()}else{wpLink.htmlUpdate()}},htmlUpdate:function(){var f,e,i,b,a,d,h,g=wpLink.textarea;if(!g){return}f=wpLink.getAttrs();e=v.text.val();var c=document.createElement("a");c.href=f.href;if("javascript:"===c.protocol||"data:"===c.protocol){f.href=""}if(!f.href){return}i=wpLink.buildHtml(f);if(document.selection&&wpLink.range){g.focus();wpLink.range.text=i+(e||wpLink.range.text)+"</a>";wpLink.range.moveToBookmark(wpLink.range.getBookmark());wpLink.range.select();wpLink.range=null}else{if(typeof g.selectionStart!=="undefined"){b=g.selectionStart;a=g.selectionEnd;h=e||g.value.substring(b,a);i=i+h+"</a>";d=b+i.length;if(b===a&&!h){d-=4}g.value=(g.value.substring(0,b)+i+g.value.substring(a,g.value.length));g.selectionStart=g.selectionEnd=d}}wpLink.close();g.focus();z(g).trigger("change");r.a11y.speak(x.linkInserted)},mceUpdate:function(){var e=wpLink.getAttrs(),f,b,d,c;var a=document.createElement("a");a.href=e.href;if("javascript:"===a.protocol||"data:"===a.protocol){e.href=""}if(!e.href){u.execCommand("unlink");wpLink.close();return}f=u.$(s());u.undoManager.transact(function(){if(!f.length){u.execCommand("mceInsertLink",false,{href:"_wp_link_placeholder","data-wp-temp-link":1});f=u.$('a[data-wp-temp-link="1"]').removeAttr("data-wp-temp-link");d=z.trim(f.text())}if(!f.length){u.execCommand("unlink")}else{if(v.wrap.hasClass("has-text-field")){b=v.text.val();if(b){f.text(b)}else{if(!d){f.text(e.href)}}}e["data-wplink-edit"]=null;e["data-mce-href"]=null;f.attr(e)}});wpLink.close("noReset");u.focus();if(f.length){c=f.parent("#_mce_caret");if(c.length){c.before(f.removeAttr("data-mce-bogus"))}u.selection.select(f[0]);u.selection.collapse();if(u.plugins.wplink){u.plugins.wplink.checkLink(f[0])}}u.nodeChanged();r.a11y.speak(x.linkInserted)},updateFields:function(a,b){v.url.val(b.children(".item-permalink").val())},getUrlFromSelection:function(a){if(!a){if(this.isMCE()){a=u.selection.getContent({format:"text"})}else{if(document.selection&&wpLink.range){a=wpLink.range.text}else{if(typeof this.textarea.selectionStart!=="undefined"){a=this.textarea.value.substring(this.textarea.selectionStart,this.textarea.selectionEnd)}}}}a=z.trim(a);if(a&&q.test(a)){return"mailto:"+a}else{if(a&&y.test(a)){return a.replace(/&amp;|&#0?38;/gi,"&")}}return""},setDefaultValues:function(a){v.url.val(this.getUrlFromSelection(a));v.search.val("");wpLink.searchInternalLinks();v.submit.val(x.save)},searchInternalLinks:function(){var a,b=v.search.val()||"";if(b.length>2){B.recent.hide();B.search.show();if(wpLink.lastSearch==b){return}wpLink.lastSearch=b;a=v.search.parent().find(".spinner").addClass("is-active");B.search.change(b);B.search.ajax(function(){a.removeClass("is-active")})}else{B.search.hide();B.recent.show()}},next:function(){B.search.next();B.recent.next()},prev:function(){B.search.prev();B.recent.prev()},keydown:function(b){var c,a;if(27===b.keyCode){wpLink.close();b.stopImmediatePropagation()}else{if(9===b.keyCode){a=b.target.id;if(a==="wp-link-submit"&&!b.shiftKey){v.close.focus();b.preventDefault()}else{if(a==="wp-link-close"&&b.shiftKey){v.submit.focus();b.preventDefault()}}}}if(38!==b.keyCode&&40!==b.keyCode){return}if(document.activeElement&&(document.activeElement.id==="link-title-field"||document.activeElement.id==="url-field")){return}c=38===b.keyCode?"prev":"next";clearInterval(wpLink.keyInterval);wpLink[c]();wpLink.keyInterval=setInterval(wpLink[c],wpLink.keySensitivity);b.preventDefault()},keyup:function(a){if(38===a.keyCode||40===a.keyCode){clearInterval(wpLink.keyInterval);a.preventDefault()}},delayedCallback:function(d,f){var a,b,c,e;if(!f){return d}setTimeout(function(){if(b){return d.apply(e,c)}a=true},f);return function(){if(a){return d.apply(this,arguments)}c=arguments;e=this;b=true}}};D=function(a,b){var c=this;this.element=a;this.ul=a.children("ul");this.contentHeight=a.children("#link-selector-height");this.waiting=a.find(".river-waiting");this.change(b);this.refresh();z("#wp-link .query-results, #wp-link #link-selector").scroll(function(){c.maybeLoad()});a.on("click","li",function(d){c.select(z(this),d)})};z.extend(D.prototype,{refresh:function(){this.deselect();this.visible=this.element.is(":visible")},show:function(){if(!this.visible){this.deselect();this.element.show();this.visible=true}},hide:function(){this.element.hide();this.visible=false},select:function(e,b){var c,d,a,f;if(e.hasClass("unselectable")||e==this.selected){return}this.deselect();this.selected=e.addClass("selected");c=e.outerHeight();d=this.element.height();a=e.position().top;f=this.element.scrollTop();if(a<0){this.element.scrollTop(f+a)}else{if(a+c>d){this.element.scrollTop(f+a-d+c)}}this.element.trigger("river-select",[e,b,this])},deselect:function(){if(this.selected){this.selected.removeClass("selected")}this.selected=false},prev:function(){if(!this.visible){return}var a;if(this.selected){a=this.selected.prev("li");if(a.length){this.select(a)}}},next:function(){if(!this.visible){return}var a=this.selected?this.selected.next("li"):z("li:not(.unselectable):first",this.element);if(a.length){this.select(a)}},ajax:function(a){var c=this,b=this.query.page==1?0:wpLink.minRiverAJAXDuration,d=wpLink.delayedCallback(function(f,e){c.process(f,e);if(a){a(f,e)}},b);this.query.ajax(d)},change:function(a){if(this.query&&this._search==a){return}this._search=a;this.query=new w(a);this.element.scrollTop(0)},process:function(e,a){var d="",c=true,f="",b=a.page==1;if(!e){if(b){d+='<li class="unselectable no-matches-found"><span class="item-title"><em>'+x.noMatchesFound+"</em></span></li>"}}else{z.each(e,function(){f=c?"alternate":"";f+=this.title?"":" no-title";d+=f?'<li class="'+f+'">':"<li>";d+='<input type="hidden" class="item-permalink" value="'+this.permalink+'" />';d+='<span class="item-title">';d+=this.title?this.title:x.noTitle;d+='</span><span class="item-info">'+this.info+"</span></li>";c=!c})}this.ul[b?"html":"append"](d)},maybeLoad:function(){var b=this,a=this.element,c=a.scrollTop()+a.height();if(!this.query.ready()||c<this.contentHeight.height()-wpLink.riverBottomThreshold){return}setTimeout(function(){var e=a.scrollTop(),d=e+a.height();if(!b.query.ready()||d<b.contentHeight.height()-wpLink.riverBottomThreshold){return}b.waiting.addClass("is-active");a.scrollTop(e+b.waiting.outerHeight());b.ajax(function(){b.waiting.removeClass("is-active")})},wpLink.timeToTriggerRiver)}});w=function(a){this.page=1;this.allLoaded=false;this.querying=false;this.search=a};z.extend(w.prototype,{ready:function(){return !(this.querying||this.allLoaded)},ajax:function(a){var c=this,b={action:"wp-link-ajax",page:this.page,_ajax_linking_nonce:v.nonce.val()};if(this.search){b.search=this.search}this.querying=true;z.post(window.ajaxurl,b,function(d){c.page++;c.querying=false;c.allLoaded=!d;a(d,b)},"json")}});z(document).ready(wpLink.init)})(jQuery,window.wpLinkL10n,window.wp);