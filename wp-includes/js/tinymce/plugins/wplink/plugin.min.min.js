(function(b){b.ui.Factory.add("WPLinkPreview",b.ui.Control.extend({url:"#",renderHtml:function(){return('<div id="'+this._id+'" class="wp-link-preview"><a href="'+this.url+'" target="_blank" rel="noopener" tabindex="-1">'+this.url+"</a></div>")},setURL:function(f){var a,e;if(this.url!==f){this.url=f;f=window.decodeURIComponent(f);f=f.replace(/^(?:https?:)?\/\/(?:www\.)?/,"");if((a=f.indexOf("?"))!==-1){f=f.slice(0,a)}if((a=f.indexOf("#"))!==-1){f=f.slice(0,a)}f=f.replace(/(?:index)?\.html$/,"");if(f.charAt(f.length-1)==="/"){f=f.slice(0,-1)}if(f===""){f=this.url}if(f.length>40&&(a=f.indexOf("/"))!==-1&&(e=f.lastIndexOf("/"))!==-1&&e!==a){if(a+f.length-e<40){e=-(40-(a+1))}f=f.slice(0,a+1)+"\u2026"+f.slice(e)}b.$(this.getEl().firstChild).attr("href",this.url).text(f)}}}));b.ui.Factory.add("WPLinkInput",b.ui.Control.extend({renderHtml:function(){return('<div id="'+this._id+'" class="wp-link-input"><input type="text" value="" placeholder="'+b.translate("Paste URL or type to search")+'" /><input type="text" style="display:none" value="" /></div>')},setURL:function(a){this.getEl().firstChild.value=a},getURL:function(){return b.trim(this.getEl().firstChild.value)},getLinkText:function(){var a=this.getEl().firstChild.nextSibling.value;if(!b.trim(a)){return""}return a.replace(/[\r\n\t ]+/g," ")},reset:function(){var a=this.getEl().firstChild;a.value="";a.nextSibling.value=""}}));b.PluginManager.add("wplink",function(E){var B;var v;var J;var H;var G;var w;var u;var D=window.jQuery;var A=/^(mailto:)?[a-z0-9._%+-]+@[a-z0-9][a-z0-9.-]*\.[a-z]{2,63}$/i;var I=/^https?:\/\/([^\s/?.#-][^\s\/?.#]*\.?)+(\/[^\s"]*)?$/i;var a=/^https?:\/\/[^\/]+\.[^\/]+($|\/)/i;var C=(typeof window.wp!=="undefined"&&window.wp.a11y&&window.wp.a11y.speak)?window.wp.a11y.speak:function(){};var z=false;function t(){var f,e,c=E.selection.getStart(),d=E.dom.getParent(c,"a[href]");if(!d){e=E.selection.getContent({format:"raw"});if(e&&e.indexOf("</a>")!==-1){f=e.match(/href="([^">]+)"/);if(f&&f[1]){d=E.$('a[href="'+f[1]+'"]',c)[0]}if(d){E.selection.select(d)}}}return d}function F(){E.$("a").each(function(c,d){var e=E.$(d);if(e.attr("href")==="_wp_link_placeholder"){E.dom.remove(d,true)}else{if(e.attr("data-wplink-edit")){e.attr("data-wplink-edit",null)}}})}function y(d,c){return d.replace(/(<a [^>]+>)([\s\S]*?)<\/a>/g,function(f,g,e){if(g.indexOf(' href="_wp_link_placeholder"')>-1){return e}if(c){g=g.replace(/ data-wplink-edit="true"/g,"")}g=g.replace(/ data-wplink-url-error="true"/g,"");return g+e+"</a>"})}function x(c){var d=E.$(c);var e=d.attr("href");if(!e||typeof D==="undefined"){return}z=false;if(/^http/i.test(e)&&(!I.test(e)||!a.test(e))){z=true;d.attr("data-wplink-url-error","true");C(E.translate("Warning: the link has been inserted but may have errors. Please test it."),"assertive")}else{d.removeAttr("data-wplink-url-error")}}E.on("preinit",function(){if(E.wp&&E.wp._createToolbar){B=E.wp._createToolbar(["wp_link_preview","wp_link_edit","wp_link_remove"],true);var c=["wp_link_input","wp_link_apply"];if(typeof window.wpLink!=="undefined"){c.push("wp_link_advanced")}v=E.wp._createToolbar(c,true);v.on("show",function(){if(typeof window.wpLink==="undefined"||!window.wpLink.modalOpen){window.setTimeout(function(){var e=v.$el.find("input.ui-autocomplete-input")[0],d=G&&(G.textContent||G.innerText);if(e){if(!e.value&&d&&typeof window.wpLink!=="undefined"){e.value=window.wpLink.getUrlFromSelection(d)}if(!w){e.focus();e.select()}}})}});v.on("hide",function(){if(!v.scrolling){E.execCommand("wp_link_cancel")}})}});E.addCommand("WP_Link",function(){if(b.Env.ie&&b.Env.ie<10&&typeof window.wpLink!=="undefined"){window.wpLink.open(E.id);return}G=t();v.tempHide=false;if(G){E.dom.setAttribs(G,{"data-wplink-edit":true})}else{F();E.execCommand("mceInsertLink",false,{href:"_wp_link_placeholder"});G=E.$('a[href="_wp_link_placeholder"]')[0];E.nodeChanged()}});E.addCommand("wp_link_apply",function(){if(v.scrolling){return}var e,d;if(G){e=H.getURL();d=H.getLinkText();E.focus();var c=document.createElement("a");c.href=e;if("javascript:"===c.protocol||"data:"===c.protocol){e=""}if(!e){E.dom.remove(G,true);return}if(!/^(?:[a-z]+:|#|\?|\.|\/)/.test(e)&&!A.test(e)){e="http://"+e}E.dom.setAttribs(G,{href:e,"data-wplink-edit":null});if(!b.trim(G.innerHTML)){E.$(G).text(d||e)}x(G)}H.reset();E.nodeChanged();if(typeof window.wpLinkL10n!=="undefined"&&!z){C(window.wpLinkL10n.linkInserted)}});E.addCommand("wp_link_cancel",function(){if(!v.tempHide){H.reset();F()}});E.addCommand("wp_unlink",function(){E.execCommand("unlink");v.tempHide=false;E.execCommand("wp_link_cancel")});E.addShortcut("access+a","","WP_Link");E.addShortcut("access+s","","wp_unlink");E.addShortcut("meta+k","","WP_Link");E.addButton("link",{icon:"link",tooltip:"Insert/edit link",cmd:"WP_Link",stateSelector:"a[href]"});E.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink"});E.addMenuItem("link",{icon:"link",text:"Insert/edit link",cmd:"WP_Link",stateSelector:"a[href]",context:"insert",prependToContext:true});E.on("pastepreprocess",function(c){var e=c.content,d=/^(?:https?:)?\/\/\S+$/i;if(!E.selection.isCollapsed()&&!d.test(E.selection.getContent())){e=e.replace(/<[^>]+>/g,"");e=b.trim(e);if(d.test(e)){E.execCommand("mceInsertLink",false,{href:E.dom.decode(e)});c.preventDefault()}}});E.on("savecontent",function(c){c.content=y(c.content,true)});E.on("BeforeAddUndo",function(c){if(c.lastLevel&&c.lastLevel.content&&c.level.content&&c.lastLevel.content===y(c.level.content)){c.preventDefault()}});E.on("keydown",function(c){if(c.keyCode===27){E.execCommand("wp_link_cancel")}if(c.altKey||(b.Env.mac&&(!c.metaKey||c.ctrlKey))||(!b.Env.mac&&!c.ctrlKey)){return}if(c.keyCode===89||c.keyCode===90){w=true;window.clearTimeout(u);u=window.setTimeout(function(){w=false},500)}});E.addButton("wp_link_preview",{type:"WPLinkPreview",onPostRender:function(){J=this}});E.addButton("wp_link_input",{type:"WPLinkInput",onPostRender:function(){var e=this.getEl(),f=e.firstChild,c,g,d;H=this;if(D&&D.ui&&D.ui.autocomplete){c=D(f);c.on("keydown",function(){c.removeAttr("aria-activedescendant")}).autocomplete({source:function(h,i){if(d===h.term){i(g);return}if(/^https?:/.test(h.term)||h.term.indexOf(".")!==-1){return i()}D.post(window.ajaxurl,{action:"wp-link-ajax",page:1,search:h.term,_ajax_linking_nonce:D("#_ajax_linking_nonce").val()},function(j){g=j;i(j)},"json");d=h.term},focus:function(i,h){c.attr("aria-activedescendant","mce-wp-autocomplete-"+h.item.ID);i.preventDefault()},select:function(i,h){c.val(h.item.permalink);D(e.firstChild.nextSibling).val(h.item.title);if(9===i.keyCode&&typeof window.wpLinkL10n!=="undefined"){C(window.wpLinkL10n.linkSelected)}return false},open:function(){c.attr("aria-expanded","true");v.blockHide=true},close:function(){c.attr("aria-expanded","false");v.blockHide=false},minLength:2,position:{my:"left top+2"},messages:{noResults:(typeof window.uiAutocompleteL10n!=="undefined")?window.uiAutocompleteL10n.noResults:"",results:function(h){if(typeof window.uiAutocompleteL10n!=="undefined"){if(h>1){return window.uiAutocompleteL10n.manyResults.replace("%d",h)}return window.uiAutocompleteL10n.oneResult}}}}).autocomplete("instance")._renderItem=function(i,h){return D('<li role="option" id="mce-wp-autocomplete-'+h.ID+'">').append("<span>"+h.title+'</span>&nbsp;<span class="wp-editor-float-right">'+h.info+"</span>").appendTo(i)};c.attr({role:"combobox","aria-autocomplete":"list","aria-expanded":"false","aria-owns":c.autocomplete("widget").attr("id")}).on("focus",function(){var h=c.val();if(h&&!/^https?:/.test(h)){c.autocomplete("search")}}).autocomplete("widget").addClass("wplink-autocomplete").attr("role","listbox").removeAttr("tabindex").on("menufocus",function(i,h){h.item.attr("aria-selected","true")}).on("menublur",function(){D(this).find('[aria-selected="true"]').removeAttr("aria-selected")})}b.$(f).on("keydown",function(h){if(h.keyCode===13){E.execCommand("wp_link_apply");h.preventDefault()}})}});E.on("wptoolbar",function(d){var g=E.dom.getParent(d.element,"a"),c,f,e;if(typeof window.wpLink!=="undefined"&&window.wpLink.modalOpen){v.tempHide=true;return}v.tempHide=false;if(g){c=E.$(g);f=c.attr("href");e=c.attr("data-wplink-edit");if(f==="_wp_link_placeholder"||e){if(f!=="_wp_link_placeholder"&&!H.getURL()){H.setURL(f)}d.element=g;d.toolbar=v}else{if(f&&!c.find("img").length){J.setURL(f);d.element=g;d.toolbar=B;if(c.attr("data-wplink-url-error")==="true"){B.$el.find(".wp-link-preview a").addClass("wplink-url-error")}else{B.$el.find(".wp-link-preview a").removeClass("wplink-url-error");z=false}}}}else{if(v.visible()){E.execCommand("wp_link_cancel")}}});E.addButton("wp_link_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",cmd:"WP_Link"});E.addButton("wp_link_remove",{tooltip:"Remove link",icon:"dashicon dashicons-editor-unlink",cmd:"wp_unlink"});E.addButton("wp_link_advanced",{tooltip:"Link options",icon:"dashicon dashicons-admin-generic",onclick:function(){if(typeof window.wpLink!=="undefined"){var d=H.getURL()||null,c=H.getLinkText()||null;if(b.Env.ie){E.focus()}v.tempHide=true;window.wpLink.open(E.id,d,c,G);H.reset()}}});E.addButton("wp_link_apply",{tooltip:"Apply",icon:"dashicon dashicons-editor-break",cmd:"wp_link_apply",classes:"widget btn primary"});return{close:function(){v.tempHide=false;E.execCommand("wp_link_cancel")},checkLink:x}})})(window.tinymce);