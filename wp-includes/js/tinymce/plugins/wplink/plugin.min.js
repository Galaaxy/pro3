(function(a){a.ui.Factory.add("WPLinkPreview",a.ui.Control.extend({url:"#",renderHtml:function(){return('<div id="'+this._id+'" class="wp-link-preview"><a href="'+this.url+'" target="_blank" rel="noopener" tabindex="-1">'+this.url+"</a></div>")},setURL:function(c){var b,d;if(this.url!==c){this.url=c;c=window.decodeURIComponent(c);c=c.replace(/^(?:https?:)?\/\/(?:www\.)?/,"");if((b=c.indexOf("?"))!==-1){c=c.slice(0,b)}if((b=c.indexOf("#"))!==-1){c=c.slice(0,b)}c=c.replace(/(?:index)?\.html$/,"");if(c.charAt(c.length-1)==="/"){c=c.slice(0,-1)}if(c===""){c=this.url}if(c.length>40&&(b=c.indexOf("/"))!==-1&&(d=c.lastIndexOf("/"))!==-1&&d!==b){if(b+c.length-d<40){d=-(40-(b+1))}c=c.slice(0,b+1)+"\u2026"+c.slice(d)}a.$(this.getEl().firstChild).attr("href",this.url).text(c)}}}));a.ui.Factory.add("WPLinkInput",a.ui.Control.extend({renderHtml:function(){return('<div id="'+this._id+'" class="wp-link-input"><input type="text" value="" placeholder="'+a.translate("Paste URL or type to search")+'" /><input type="text" style="display:none" value="" /></div>')},setURL:function(b){this.getEl().firstChild.value=b},getURL:function(){return a.trim(this.getEl().firstChild.value)},getLinkText:function(){var b=this.getEl().firstChild.nextSibling.value;if(!a.trim(b)){return""}return b.replace(/[\r\n\t ]+/g," ")},reset:function(){var b=this.getEl().firstChild;b.value="";b.nextSibling.value=""}}));a.PluginManager.add("wplink",function(g){var j;var p;var b;var d;var e;var o;var q;var h=window.jQuery;var k=/^(mailto:)?[a-z0-9._%+-]+@[a-z0-9][a-z0-9.-]*\.[a-z]{2,63}$/i;var c=/^https?:\/\/([^\s/?.#-][^\s\/?.#]*\.?)+(\/[^\s"]*)?$/i;var s=/^https?:\/\/[^\/]+\.[^\/]+($|\/)/i;var i=(typeof window.wp!=="undefined"&&window.wp.a11y&&window.wp.a11y.speak)?window.wp.a11y.speak:function(){};var l=false;function r(){var t,u,w=g.selection.getStart(),v=g.dom.getParent(w,"a[href]");if(!v){u=g.selection.getContent({format:"raw"});if(u&&u.indexOf("</a>")!==-1){t=u.match(/href="([^">]+)"/);if(t&&t[1]){v=g.$('a[href="'+t[1]+'"]',w)[0]}if(v){g.selection.select(v)}}}return v}function f(){g.$("a").each(function(v,u){var t=g.$(u);if(t.attr("href")==="_wp_link_placeholder"){g.dom.remove(u,true)}else{if(t.attr("data-wplink-edit")){t.attr("data-wplink-edit",null)}}})}function m(t,u){return t.replace(/(<a [^>]+>)([\s\S]*?)<\/a>/g,function(w,v,x){if(v.indexOf(' href="_wp_link_placeholder"')>-1){return x}if(u){v=v.replace(/ data-wplink-edit="true"/g,"")}v=v.replace(/ data-wplink-url-error="true"/g,"");return v+x+"</a>"})}function n(v){var u=g.$(v);var t=u.attr("href");if(!t||typeof h==="undefined"){return}l=false;if(/^http/i.test(t)&&(!c.test(t)||!s.test(t))){l=true;u.attr("data-wplink-url-error","true");i(g.translate("Warning: the link has been inserted but may have errors. Please test it."),"assertive")}else{u.removeAttr("data-wplink-url-error")}}g.on("preinit",function(){if(g.wp&&g.wp._createToolbar){j=g.wp._createToolbar(["wp_link_preview","wp_link_edit","wp_link_remove"],true);var t=["wp_link_input","wp_link_apply"];if(typeof window.wpLink!=="undefined"){t.push("wp_link_advanced")}p=g.wp._createToolbar(t,true);p.on("show",function(){if(typeof window.wpLink==="undefined"||!window.wpLink.modalOpen){window.setTimeout(function(){var u=p.$el.find("input.ui-autocomplete-input")[0],v=e&&(e.textContent||e.innerText);if(u){if(!u.value&&v&&typeof window.wpLink!=="undefined"){u.value=window.wpLink.getUrlFromSelection(v)}if(!o){u.focus();u.select()}}})}});p.on("hide",function(){if(!p.scrolling){g.execCommand("wp_link_cancel")}})}});g.addCommand("WP_Link",function(){if(a.Env.ie&&a.Env.ie<10&&typeof window.wpLink!=="undefined"){window.wpLink.open(g.id);return}e=r();p.tempHide=false;if(e){g.dom.setAttribs(e,{"data-wplink-edit":true})}else{f();g.execCommand("mceInsertLink",false,{href:"_wp_link_placeholder"});e=g.$('a[href="_wp_link_placeholder"]')[0];g.nodeChanged()}});g.addCommand("wp_link_apply",function(){if(p.scrolling){return}var t,u;if(e){t=d.getURL();u=d.getLinkText();g.focus();var v=document.createElement("a");v.href=t;if("javascript:"===v.protocol||"data:"===v.protocol){t=""}if(!t){g.dom.remove(e,true);return}if(!/^(?:[a-z]+:|#|\?|\.|\/)/.test(t)&&!k.test(t)){t="http://"+t}g.dom.setAttribs(e,{href:t,"data-wplink-edit":null});if(!a.trim(e.innerHTML)){g.$(e).text(u||t)}n(e)}d.reset();g.nodeChanged();if(typeof window.wpLinkL10n!=="undefined"&&!l){i(window.wpLinkL10n.linkInserted)}});g.addCommand("wp_link_cancel",function(){if(!p.tempHide){d.reset();f()}});g.addCommand("wp_unlink",function(){g.execCommand("unlink");p.tempHide=false;g.execCommand("wp_link_cancel")});g.addShortcut("access+a","","WP_Link");g.addShortcut("access+s","","wp_unlink");g.addShortcut("meta+k","","WP_Link");g.addButton("link",{icon:"link",tooltip:"Insert/edit link",cmd:"WP_Link",stateSelector:"a[href]"});g.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink"});g.addMenuItem("link",{icon:"link",text:"Insert/edit link",cmd:"WP_Link",stateSelector:"a[href]",context:"insert",prependToContext:true});g.on("pastepreprocess",function(v){var t=v.content,u=/^(?:https?:)?\/\/\S+$/i;if(!g.selection.isCollapsed()&&!u.test(g.selection.getContent())){t=t.replace(/<[^>]+>/g,"");t=a.trim(t);if(u.test(t)){g.execCommand("mceInsertLink",false,{href:g.dom.decode(t)});v.preventDefault()}}});g.on("savecontent",function(t){t.content=m(t.content,true)});g.on("BeforeAddUndo",function(t){if(t.lastLevel&&t.lastLevel.content&&t.level.content&&t.lastLevel.content===m(t.level.content)){t.preventDefault()}});g.on("keydown",function(t){if(t.keyCode===27){g.execCommand("wp_link_cancel")}if(t.altKey||(a.Env.mac&&(!t.metaKey||t.ctrlKey))||(!a.Env.mac&&!t.ctrlKey)){return}if(t.keyCode===89||t.keyCode===90){o=true;window.clearTimeout(q);q=window.setTimeout(function(){o=false},500)}});g.addButton("wp_link_preview",{type:"WPLinkPreview",onPostRender:function(){b=this}});g.addButton("wp_link_input",{type:"WPLinkInput",onPostRender:function(){var v=this.getEl(),u=v.firstChild,x,t,w;d=this;if(h&&h.ui&&h.ui.autocomplete){x=h(u);x.on("keydown",function(){x.removeAttr("aria-activedescendant")}).autocomplete({source:function(z,y){if(w===z.term){y(t);return}if(/^https?:/.test(z.term)||z.term.indexOf(".")!==-1){return y()}h.post(window.ajaxurl,{action:"wp-link-ajax",page:1,search:z.term,_ajax_linking_nonce:h("#_ajax_linking_nonce").val()},function(A){t=A;y(A)},"json");w=z.term},focus:function(y,z){x.attr("aria-activedescendant","mce-wp-autocomplete-"+z.item.ID);y.preventDefault()},select:function(y,z){x.val(z.item.permalink);h(v.firstChild.nextSibling).val(z.item.title);if(9===y.keyCode&&typeof window.wpLinkL10n!=="undefined"){i(window.wpLinkL10n.linkSelected)}return false},open:function(){x.attr("aria-expanded","true");p.blockHide=true},close:function(){x.attr("aria-expanded","false");p.blockHide=false},minLength:2,position:{my:"left top+2"},messages:{noResults:(typeof window.uiAutocompleteL10n!=="undefined")?window.uiAutocompleteL10n.noResults:"",results:function(y){if(typeof window.uiAutocompleteL10n!=="undefined"){if(y>1){return window.uiAutocompleteL10n.manyResults.replace("%d",y)}return window.uiAutocompleteL10n.oneResult}}}}).autocomplete("instance")._renderItem=function(y,z){return h('<li role="option" id="mce-wp-autocomplete-'+z.ID+'">').append("<span>"+z.title+'</span>&nbsp;<span class="wp-editor-float-right">'+z.info+"</span>").appendTo(y)};x.attr({role:"combobox","aria-autocomplete":"list","aria-expanded":"false","aria-owns":x.autocomplete("widget").attr("id")}).on("focus",function(){var y=x.val();if(y&&!/^https?:/.test(y)){x.autocomplete("search")}}).autocomplete("widget").addClass("wplink-autocomplete").attr("role","listbox").removeAttr("tabindex").on("menufocus",function(y,z){z.item.attr("aria-selected","true")}).on("menublur",function(){h(this).find('[aria-selected="true"]').removeAttr("aria-selected")})}a.$(u).on("keydown",function(y){if(y.keyCode===13){g.execCommand("wp_link_apply");y.preventDefault()}})}});g.on("wptoolbar",function(w){var t=g.dom.getParent(w.element,"a"),x,u,v;if(typeof window.wpLink!=="undefined"&&window.wpLink.modalOpen){p.tempHide=true;return}p.tempHide=false;if(t){x=g.$(t);u=x.attr("href");v=x.attr("data-wplink-edit");if(u==="_wp_link_placeholder"||v){if(u!=="_wp_link_placeholder"&&!d.getURL()){d.setURL(u)}w.element=t;w.toolbar=p}else{if(u&&!x.find("img").length){b.setURL(u);w.element=t;w.toolbar=j;if(x.attr("data-wplink-url-error")==="true"){j.$el.find(".wp-link-preview a").addClass("wplink-url-error")}else{j.$el.find(".wp-link-preview a").removeClass("wplink-url-error");l=false}}}}else{if(p.visible()){g.execCommand("wp_link_cancel")}}});g.addButton("wp_link_edit",{tooltip:"Edit ",icon:"dashicon dashicons-edit",cmd:"WP_Link"});g.addButton("wp_link_remove",{tooltip:"Remove link",icon:"dashicon dashicons-editor-unlink",cmd:"wp_unlink"});g.addButton("wp_link_advanced",{tooltip:"Link options",icon:"dashicon dashicons-admin-generic",onclick:function(){if(typeof window.wpLink!=="undefined"){var t=d.getURL()||null,u=d.getLinkText()||null;if(a.Env.ie){g.focus()}p.tempHide=true;window.wpLink.open(g.id,t,u,e);d.reset()}}});g.addButton("wp_link_apply",{tooltip:"Apply",icon:"dashicon dashicons-editor-break",cmd:"wp_link_apply",classes:"widget btn primary"});return{close:function(){p.tempHide=false;g.execCommand("wp_link_cancel")},checkLink:n}})})(window.tinymce);