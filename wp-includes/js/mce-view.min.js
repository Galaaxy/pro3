(function(d,b,c,e){var a={},f={};b.mce=b.mce||{};b.mce.views={register:function(g,h){a[g]=b.mce.View.extend(_.extend(h,{type:g}))},unregister:function(g){delete a[g]},get:function(g){return a[g]},unbind:function(){_.each(f,function(g){g.unbind()})},setMarkers:function(j){var i=[{content:j}],h=this,g,k;_.each(a,function(l,m){k=i.slice();i=[];_.each(k,function(p){var o=p.content,n,q;if(p.processed){i.push(p);return}while(o&&(n=l.prototype.match(o))){if(n.index){i.push({content:o.substring(0,n.index)})}g=h.createInstance(m,n.content,n.options);q=g.loader?".":g.text;i.push({content:g.ignore?q:'<p data-wpview-marker="'+g.encodedText+'">'+q+"</p>",processed:true});o=o.slice(n.index+n.content.length)}if(o){i.push({content:o})}})});j=_.pluck(i,"content").join("");return j.replace(/<p>\s*<p data-wpview-marker=/g,"<p data-wpview-marker=").replace(/<\/p>\s*<\/p>/g,"</p>")},createInstance:function(j,m,h,k){var l=this.get(j),i,g;if(m.indexOf("[")!==-1&&m.indexOf("]")!==-1){m=m.replace(/\[[^\]]+\]/g,function(n){return n.replace(/[\r\n]/g,"")})}if(!k){g=this.getInstance(m);if(g){return g}}i=encodeURIComponent(m);h=_.extend(h||{},{text:m,encodedText:i});return f[i]=new l(h)},getInstance:function(g){if(typeof g==="string"){return f[encodeURIComponent(g)]}return f[e(g).attr("data-wpview-text")]},getText:function(g){return decodeURIComponent(e(g).attr("data-wpview-text")||"")},render:function(g){_.each(f,function(h){h.render(null,g)})},update:function(k,h,i,j){var g=this.getInstance(i);if(g){g.update(k,h,i,j)}},edit:function(h,i){var g=this.getInstance(i);if(g&&g.edit){g.edit(g.text,function(k,j){g.update(k,h,i,j)})}},remove:function(h,i){var g=this.getInstance(i);if(g){g.remove(h,i)}}};b.mce.View=function(g){_.extend(this,g);this.initialize()};b.mce.View.extend=Backbone.View.extend;_.extend(b.mce.View.prototype,{content:null,loader:true,initialize:function(){},getContent:function(){return this.content},render:function(g,h){if(g!=null){this.content=g}g=this.getContent();if(!this.loader&&!g){return}h&&this.unbind();this.replaceMarkers();if(g){this.setContent(g,function(i,j){e(j).data("rendered",true);this.bindNode.call(this,i,j)},h?null:false)}else{this.setLoader()}},bindNode:function(){},unbindNode:function(){},unbind:function(){this.getNodes(function(g,h){this.unbindNode.call(this,g,h)},true)},getEditors:function(g){_.each(tinymce.editors,function(h){if(h.plugins.wpview){g.call(this,h)}},this)},getNodes:function(h,g){this.getEditors(function(j){var i=this;e(j.getBody()).find('[data-wpview-text="'+i.encodedText+'"]').filter(function(){var k;if(g==null){return true}k=e(this).data("rendered")===true;return g?k:!k}).each(function(){h.call(i,j,this,this)})})},getMarkers:function(g){this.getEditors(function(i){var h=this;e(i.getBody()).find('[data-wpview-marker="'+this.encodedText+'"]').each(function(){g.call(h,i,this)})})},replaceMarkers:function(){this.getMarkers(function(h,i){var g=i===h.selection.getNode();var j;if(!this.loader&&e(i).text()!==tinymce.DOM.decode(this.text)){h.dom.setAttrib(i,"data-wpview-marker",null);return}j=h.$('<div class="wpview wpview-wrap" data-wpview-text="'+this.encodedText+'" data-wpview-type="'+this.type+'" contenteditable="false"></div>');h.$(i).replaceWith(j);if(g){setTimeout(function(){h.selection.select(j[0]);h.selection.collapse()})}})},removeMarkers:function(){this.getMarkers(function(g,h){g.dom.setAttrib(h,"data-wpview-marker",null)})},setContent:function(g,i,h){if(_.isObject(g)&&(g.sandbox||g.head||g.body.indexOf("<script")!==-1)){this.setIframes(g.head||"",g.body,i,h)}else{if(_.isString(g)&&g.indexOf("<script")!==-1){this.setIframes("",g,i,h)}else{this.getNodes(function(j,k){g=g.body||g;if(g.indexOf("<iframe")!==-1){g+='<span class="mce-shim"></span>'}j.undoManager.transact(function(){k.innerHTML="";k.appendChild(_.isString(g)?j.dom.createFragment(g):g);j.dom.add(k,"span",{"class":"wpview-end"})});i&&i.call(this,j,k)},h)}}},setIframes:function(j,g,l,k){var i=this;if(g.indexOf("[")!==-1&&g.indexOf("]")!==-1){var h=new RegExp("\\[\\/?(?:"+d.mceViewL10n.shortcodes.join("|")+")[^\\]]*?\\]","g");g=g.replace(h,function(m){return m.replace(/</g,"&lt;").replace(/>/g,"&gt;")})}this.getNodes(function(y,r){var t=y.dom,B="",x=y.getBody().className||"",n=y.getDoc().getElementsByTagName("head")[0],v,u,A,q,z,w,s;tinymce.each(t.$('link[rel="stylesheet"]',n),function(C){if(C.href&&C.href.indexOf("skins/lightgray/content.min.css")===-1&&C.href.indexOf("skins/wordpress/wp-content.css")===-1){B+=t.getOuterHTML(C)}});if(i.iframeHeight){t.add(r,"span",{"data-mce-bogus":1,style:{display:"block",width:"100%",height:i.iframeHeight}},"\u200B")}y.undoManager.transact(function(){r.innerHTML="";v=t.add(r,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no","class":"wpview-sandbox",style:{width:"100%",display:"block"},height:i.iframeHeight});t.add(r,"span",{"class":"mce-shim"});t.add(r,"span",{"class":"wpview-end"})});if(!v.contentWindow){return}u=v.contentWindow;A=u.document;A.open();A.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+j+B+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}iframe {max-width: 100%;}</style></head><body id="wpview-iframe-sandbox" class="'+x+'">'+g+"</body></html>");A.close();function o(){var C;if(s){return}if(v.contentWindow){C=e(v);i.iframeHeight=e(A.body).height();if(C.height()!==i.iframeHeight){C.height(i.iframeHeight);y.nodeChanged()}}}if(i.iframeHeight){s=true;setTimeout(function(){s=false;o()},3000)}function m(){if(!y.isHidden()){e(r).data("rendered",null);setTimeout(function(){b.mce.views.render()})}}function p(){z=new q(_.debounce(o,100));z.observe(A.body,{attributes:true,childList:true,subtree:true})}e(u).on("load",o).on("unload",m);q=u.MutationObserver||u.WebKitMutationObserver||u.MozMutationObserver;if(q){if(!A.body){A.addEventListener("DOMContentLoaded",p,false)}else{p()}}else{for(w=1;w<6;w++){setTimeout(o,w*700)}}l&&l.call(i,y,r)},k)},setLoader:function(g){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-'+(g||"admin-media")+'"></div><div class="wpview-loading"><ins></ins></div></div>')},setError:function(h,g){this.setContent('<div class="wpview-error"><div class="dashicons dashicons-'+(g||"no")+'"></div><p>'+h+"</p></div>")},match:function(h){var g=c.next(this.type,h);if(g){return{index:g.index,content:g.content,options:{shortcode:g.shortcode}}}},update:function(j,g,h,i){_.find(a,function(k,m){var l=k.prototype.match(j);if(l){e(h).data("rendered",false);g.dom.setAttrib(h,"data-wpview-text",encodeURIComponent(j));b.mce.views.createInstance(m,j,l.options,i).render();g.selection.select(h);g.nodeChanged();g.focus();return true}})},remove:function(g,h){this.unbindNode.call(this,g,h);g.dom.remove(h);g.focus()}})})(window,window.wp,window.wp.shortcode,window.jQuery);(function(h,k,d,f){var c,l,b,g,e,a,i;function j(m){var n={};if(!h.tinymce){return m.replace(/<[^>]+>/g,"")}if(!m||(m.indexOf("<")===-1&&m.indexOf(">")===-1)){return m}e=e||new h.tinymce.html.Schema(n);a=a||new h.tinymce.html.DomParser(n,e);i=i||new h.tinymce.html.Serializer(n,e);return i.serialize(a.parse(m,{forced_root_block:false}))}c={state:[],edit:function(o,p){var m=this.type,n=d[m].edit(o);this.pausePlayers&&this.pausePlayers();_.each(this.state,function(q){n.state(q).on("update",function(r){p(d[m].shortcode(r).string(),m==="gallery")})});n.on("close",function(){n.detach()});n.open()}};l=_.extend({},c,{state:["gallery-edit"],template:d.template("editor-gallery"),initialize:function(){var m=d.gallery.attachments(this.shortcode,d.view.settings.post.id),o=this.shortcode.attrs.named,n=this;m.more().done(function(){m=m.toJSON();_.each(m,function(p){if(p.sizes){if(o.size&&p.sizes[o.size]){p.thumbnail=p.sizes[o.size]}else{if(p.sizes.thumbnail){p.thumbnail=p.sizes.thumbnail}else{if(p.sizes.full){p.thumbnail=p.sizes.full}}}}});n.render(n.template({verifyHTML:j,attachments:m,columns:o.columns?parseInt(o.columns,10):d.galleryDefaults.columns}))}).fail(function(p,q){n.setError(q)})}});b=_.extend({},c,{action:"parse-media-shortcode",initialize:function(){var m=this;if(this.url){this.loader=false;this.shortcode=d.embed.shortcode({url:this.text})}wp.ajax.post(this.action,{post_ID:d.view.settings.post.id,type:this.shortcode.tag,shortcode:this.shortcode.string()}).done(function(n){m.render(n)}).fail(function(n){if(m.url){m.ignore=true;m.removeMarkers()}else{m.setError(n.message||n.statusText,"admin-media")}});this.getEditors(function(n){n.on("wpview-selected",function(){m.pausePlayers()})})},pausePlayers:function(){this.getNodes(function(m,o,n){var p=f("iframe.wpview-sandbox",n).get(0);if(p&&(p=p.contentWindow)&&p.mejs){_.each(p.mejs.players,function(q){try{q.pause()}catch(r){}})}})}});g=_.extend({},b,{action:"parse-embed",edit:function(o,p){var n=d.embed.edit(o,this.url),m=this;this.pausePlayers();n.state("embed").props.on("change:url",function(r,q){if(q&&r.get("url")){n.state("embed").metadata=r.toJSON()}});n.state("embed").on("select",function(){var q=n.state("embed").metadata;if(m.url){p(q.url)}else{p(d.embed.shortcode(q).string())}});n.on("close",function(){n.detach()});n.open()}});k.register("gallery",_.extend({},l));k.register("audio",_.extend({},b,{state:["audio-details"]}));k.register("video",_.extend({},b,{state:["video-details"]}));k.register("playlist",_.extend({},b,{state:["playlist-edit","video-playlist-edit"]}));k.register("embed",_.extend({},g));k.register("embedURL",_.extend({},g,{match:function(o){var n=/(^|<p>)(https?:\/\/[^\s"]+?)(<\/p>\s*|$)/gi,m=n.exec(o);if(m){return{index:m.index+m[1].length,content:m[2],options:{url:true}}}}}))})(window,window.wp.mce.views,window.wp.media,window.jQuery);